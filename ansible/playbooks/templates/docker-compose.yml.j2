services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=support@ethux.net"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--providers.file=true"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
      - "./dynamic.yml:/etc/traefik/dynamic.yml"
    networks:
      - app_network

  app:
    image: {{ docker_image }}
    container_name: app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - JUPYTER_URL=https://jupyter.ethux.net
      - JUPYTER_TOKEN={{ jupyter_token | default('default_fallback_token', true) }}
      - INTERNAL_JUPYTER_URL=http://jupyter:8888
      - INTERNAL_JUPYTER_TOKEN={{ jupyter_token | default('default_fallback_token', true) }}
    volumes:
      - {{ app_data_path }}:/app/data
      - shared_data:/app
      - /opt/{{ app_name }}/.ssh:/root/.ssh:ro
    command: sh -c "/app/setup-ssh.sh && your-normal-start-command"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`mcp.ethux.net`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=myresolver"
      - "traefik.http.services.app.loadbalancer.server.port={{ app_port }}"
    networks:
      - app_network

  jupyter:
    image: jupyter/datascience-notebook:x86_64-ubuntu-22.04
    container_name: jupyter_notebook
    user: root
    restart: unless-stopped
    working_dir: /home/jupyter/app
    environment:
      - NB_USER=root
      - NB_UID=0
      - NB_GID=0
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS=-R
      - JUPYTER_TOKEN={{ jupyter_token | default('default_fallback_token', true) }}
    volumes:
      - jupyter_data:/home/jupyter/work
      - shared_data:/home/jupyter/shared
      - {{ app_data_path }}:/home/jupyter/app
    command: >
      start-notebook.sh --allow-root
      --ip=0.0.0.0
      --port=8888
      --notebook-dir=/home/jupyter/app
      --ServerApp.token={{ jupyter_token | default('default_fallback_token', true) }}
      --ServerApp.allow_remote_access=True
      --ServerApp.allow_origin='*'
      --ServerApp.base_url=/
      --ServerApp.trust_xheaders=True
      --ServerApp.disable_check_xsrf=True
      --ServerApp.tornado_settings='{
        "headers": {
          "Content-Security-Policy": "frame-ancestors *"
        }
      }'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyter.rule=Host(`jupyter.ethux.net`)"
      - "traefik.http.routers.jupyter.entrypoints=websecure"
      - "traefik.http.routers.jupyter.tls.certresolver=myresolver"
      - "traefik.http.services.jupyter.loadbalancer.server.port=8888"
      - "traefik.http.routers.jupyter.middlewares=jupyter-stripprefix@file"
      - "traefik.http.routers.jupyter.priority=10"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8888/api || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - app_network

volumes:
  jupyter_data:
  shared_data:

networks:
  app_network:
    driver: bridge